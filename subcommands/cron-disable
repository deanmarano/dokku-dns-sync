#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

# Define missing functions if needed
if ! declare -f dokku_log_info1 >/dev/null 2>&1; then
  dokku_log_info1() { echo "-----> $*"; }
fi

if ! declare -f dokku_log_info2 >/dev/null 2>&1; then
  dokku_log_info2() { echo "=====> $*"; }
fi

if ! declare -f dokku_log_warn >/dev/null 2>&1; then
  dokku_log_warn() { echo " !     $*"; }
fi

if ! declare -f dokku_log_fail >/dev/null 2>&1; then
  dokku_log_fail() { echo " !     $*" >&2; exit 1; }
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

service-cron-disable-cmd() {
  #E disable automated DNS synchronization cron job
  #E dokku $PLUGIN_COMMAND_PREFIX:cron-disable
  #E this will remove the system cron job for dns:sync-all.
  #E preserves logs and metadata for reference.
  declare desc="disable automated DNS synchronization cron job"
  local cmd="$PLUGIN_COMMAND_PREFIX:cron-disable"
  
  local CRON_DATA_DIR="$PLUGIN_DATA_ROOT/cron"
  
  # Check if cron job exists
  if ! crontab -l 2>/dev/null | grep -q "dokku dns:sync-all"; then
    dokku_log_fail "No DNS cron job found. Enable with: dokku $PLUGIN_COMMAND_PREFIX:cron-enable"
  fi
  
  dokku_log_info1 "Disabling DNS sync cron job..."
  
  # Show current job before removing
  local current_job
  current_job=$(crontab -l 2>/dev/null | grep "dokku dns:sync-all" || echo "")
  if [[ -n "$current_job" ]]; then
    dokku_log_info2 "Removing job: $current_job"
  fi
  
  # Remove the cron job from crontab
  crontab -l 2>/dev/null | grep -v "dokku dns:sync-all" | crontab -
  
  # Verify removal
  if crontab -l 2>/dev/null | grep -q "dokku dns:sync-all"; then
    dokku_log_fail "Failed to remove DNS cron job. Check system permissions."
  fi
  
  # Update status metadata
  if [[ -d "$CRON_DATA_DIR" ]]; then
    echo "disabled" > "$CRON_DATA_DIR/status"
    date +%Y-%m-%d\ %H:%M:%S > "$CRON_DATA_DIR/disabled_at"
    
    # Add log entry about disabling
    local CRON_LOG_FILE
    if [[ -f "$CRON_DATA_DIR/log_file" ]]; then
      CRON_LOG_FILE=$(cat "$CRON_DATA_DIR/log_file")
      echo "$(date): DNS cron job disabled" >> "$CRON_LOG_FILE"
    fi
  fi
  
  dokku_log_info1 "✅ DNS cron job disabled successfully!"
  echo
  dokku_log_info2 "Automated DNS synchronization is now inactive"
  dokku_log_info1 "• Cron job removed from system crontab"
  dokku_log_info1 "• Logs and metadata preserved for reference"
  dokku_log_info1 "• Check status: dokku $PLUGIN_COMMAND_PREFIX:cron"
  dokku_log_info1 "• Re-enable: dokku $PLUGIN_COMMAND_PREFIX:cron-enable"
}

service-cron-disable-cmd "$@"