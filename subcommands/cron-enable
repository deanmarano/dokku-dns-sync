#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

# Define missing functions if needed
if ! declare -f dokku_log_info1 >/dev/null 2>&1; then
  dokku_log_info1() { echo "-----> $*"; }
fi

if ! declare -f dokku_log_info2 >/dev/null 2>&1; then
  dokku_log_info2() { echo "=====> $*"; }
fi

if ! declare -f dokku_log_warn >/dev/null 2>&1; then
  dokku_log_warn() { echo " !     $*"; }
fi

if ! declare -f dokku_log_fail >/dev/null 2>&1; then
  dokku_log_fail() { echo " !     $*" >&2; exit 1; }
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

service-cron-enable-cmd() {
  #E enable automated DNS synchronization via cron
  #E dokku $PLUGIN_COMMAND_PREFIX:cron-enable
  #E this will create a system cron job that runs dns:sync-all every 24 hours.
  #E logs are stored and can be viewed with dns:cron command.
  declare desc="enable automated DNS synchronization via cron"
  local cmd="$PLUGIN_COMMAND_PREFIX:cron-enable"
  
  local CRON_DATA_DIR="$PLUGIN_DATA_ROOT/cron"
  local CRON_SCHEDULE="0 2 * * *"  # Daily at 2 AM
  local CRON_COMMAND="dokku dns:sync-all"
  local CRON_LOG_FILE="$CRON_DATA_DIR/sync.log"
  local CRON_JOB_COMMENT="# Dokku DNS auto-sync"
  local CRON_ENTRY="$CRON_SCHEDULE $CRON_COMMAND >> $CRON_LOG_FILE 2>&1 $CRON_JOB_COMMENT"
  
  # Check if DNS provider is configured
  local PROVIDER_FILE="$PLUGIN_DATA_ROOT/PROVIDER"
  if [[ ! -f "$PROVIDER_FILE" ]]; then
    dokku_log_fail "No DNS provider configured. Run: dokku $PLUGIN_COMMAND_PREFIX:configure [provider]"
  fi
  
  # Create cron data directory
  mkdir -p "$CRON_DATA_DIR"
  
  # Check if cron job already exists
  if crontab -l 2>/dev/null | grep -q "dokku dns:sync-all"; then
    dokku_log_warn "DNS cron job already exists"
    dokku_log_info1 "Current cron job:"
    crontab -l 2>/dev/null | grep "dokku dns:sync-all" || true
    dokku_log_info1 "To disable: dokku $PLUGIN_COMMAND_PREFIX:cron-disable"
    return 0
  fi
  
  # Create the cron job
  dokku_log_info1 "Creating DNS sync cron job..."
  dokku_log_info2 "Schedule: Daily at 2:00 AM (0 2 * * *)"
  dokku_log_info2 "Command: $CRON_COMMAND"
  dokku_log_info2 "Log file: $CRON_LOG_FILE"
  
  # Add cron job to crontab
  (crontab -l 2>/dev/null || echo "") | { cat; echo "$CRON_ENTRY"; } | crontab -
  
  if crontab -l 2>/dev/null | grep -q "dokku dns:sync-all"; then
    # Store cron job metadata
    echo "enabled" > "$CRON_DATA_DIR/status"
    echo "$CRON_SCHEDULE" > "$CRON_DATA_DIR/schedule"
    echo "$CRON_COMMAND" > "$CRON_DATA_DIR/command"
    echo "$CRON_LOG_FILE" > "$CRON_DATA_DIR/log_file"
    date +%Y-%m-%d\ %H:%M:%S > "$CRON_DATA_DIR/enabled_at"
    
    # Initialize log file
    echo "$(date): DNS cron job enabled" > "$CRON_LOG_FILE"
    
    dokku_log_info1 "✅ DNS cron job enabled successfully!"
    echo
    dokku_log_info2 "Automated DNS synchronization is now active"
    dokku_log_info1 "• Schedule: Daily at 2:00 AM"
    dokku_log_info1 "• Command: $CRON_COMMAND"
    dokku_log_info1 "• Log file: $CRON_LOG_FILE"
    dokku_log_info1 "• Check status: dokku $PLUGIN_COMMAND_PREFIX:cron"
    dokku_log_info1 "• Disable: dokku $PLUGIN_COMMAND_PREFIX:cron-disable"
  else
    dokku_log_fail "Failed to create DNS cron job. Check system permissions."
  fi
}

service-cron-enable-cmd "$@"